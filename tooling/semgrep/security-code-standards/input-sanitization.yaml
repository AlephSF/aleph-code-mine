# WordPress Input Sanitization Rules
#
# Detects unsanitized $_POST, $_GET, and $_REQUEST usage that could lead
# to SQL injection, XSS, or other security vulnerabilities.

rules:
  - id: unsanitized-post-access
    patterns:
      - pattern-either:
          - pattern: $_POST[$KEY]
          - pattern: $_POST["$KEY"]
          - pattern: $_POST['$KEY']
      - pattern-not-inside: sanitize_text_field( ... )
      - pattern-not-inside: sanitize_email( ... )
      - pattern-not-inside: sanitize_key( ... )
      - pattern-not-inside: sanitize_title( ... )
      - pattern-not-inside: sanitize_textarea_field( ... )
      - pattern-not-inside: absint( ... )
      - pattern-not-inside: intval( ... )
      - pattern-not-inside: wp_kses_post( ... )
      - pattern-not-inside: wp_kses( ... )
      - pattern-not-inside: wp_verify_nonce( ... )
      - pattern-not-inside: wp_unslash( ... )
    message: |
      Direct $_POST access without sanitization detected.

      Always sanitize user inputs before use to prevent SQL injection,
      XSS, and other security vulnerabilities.

      Sanitization functions:
      - sanitize_text_field() for short text inputs
      - sanitize_email() for email addresses
      - sanitize_key() for keys/slugs
      - absint() for positive integers
      - wp_kses_post() for rich HTML content

      Example:
      ❌ $name = $_POST['name'];
      ✅ $name = sanitize_text_field( $_POST['name'] );
    languages: [php]
    severity: ERROR
    metadata:
      category: security
      technology:
        - wordpress
      confidence: HIGH
      likelihood: HIGH
      impact: HIGH
      subcategory:
        - sql-injection
        - xss
      cwe:
        - "CWE-89: SQL Injection"
        - "CWE-79: Cross-site Scripting"

  - id: unsanitized-get-access
    patterns:
      - pattern-either:
          - pattern: $_GET[$KEY]
          - pattern: $_GET["$KEY"]
          - pattern: $_GET['$KEY']
      - pattern-not-inside: sanitize_text_field( ... )
      - pattern-not-inside: sanitize_email( ... )
      - pattern-not-inside: sanitize_key( ... )
      - pattern-not-inside: sanitize_title( ... )
      - pattern-not-inside: absint( ... )
      - pattern-not-inside: intval( ... )
      - pattern-not-inside: wp_verify_nonce( ... )
    message: |
      Direct $_GET access without sanitization detected.

      Example:
      ❌ $search = $_GET['s'];
      ✅ $search = sanitize_text_field( $_GET['s'] );
    languages: [php]
    severity: ERROR
    metadata:
      category: security
      technology:
        - wordpress
      confidence: HIGH

  - id: recommend-absint-for-ids
    patterns:
      - pattern-either:
          - pattern: intval( $_POST[$KEY] )
          - pattern: intval( $_GET[$KEY] )
          - pattern: (int) $_POST[$KEY]
          - pattern: (int) $_GET[$KEY]
    message: |
      Use absint() instead of intval() or (int) for IDs.

      absint() ensures positive integers, preventing negative ID attacks.

      Example:
      ❌ $post_id = intval( $_POST['post_id'] );
      ✅ $post_id = absint( $_POST['post_id'] );
    languages: [php]
    severity: INFO
    metadata:
      category: best-practice
      technology:
        - wordpress

  - id: password-sanitization-antipattern
    patterns:
      - pattern-either:
          - pattern: sanitize_text_field( $_POST["password"] )
          - pattern: sanitize_text_field( $_POST['password'] )
          - pattern: sanitize_text_field( $_POST["pass"] )
          - pattern: sanitize_text_field( $_POST['pass'] )
    message: |
      NEVER sanitize passwords! Sanitization removes special characters
      users intentionally include for password strength.

      Passwords should be hashed without modification.

      Example:
      ❌ $password = sanitize_text_field( $_POST['password'] );
      ✅ $password = $_POST['password']; // Do NOT sanitize!
         $hashed = wp_hash_password( $password );
    languages: [php]
    severity: ERROR
    metadata:
      category: security
      technology:
        - wordpress
