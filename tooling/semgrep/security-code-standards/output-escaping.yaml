# WordPress Output Escaping Rules
#
# Detects unescaped echo/print statements that could lead to XSS vulnerabilities.

rules:
  - id: unescaped-echo-variable
    patterns:
      - pattern-either:
          - pattern: echo $VAR;
          - pattern: echo $OBJ->$PROP;
          - pattern: print $VAR;
      - pattern-not: echo esc_html( ... );
      - pattern-not: echo esc_attr( ... );
      - pattern-not: echo esc_url( ... );
      - pattern-not: echo wp_kses_post( ... );
      - pattern-not: echo absint( ... );
      - pattern-not: echo intval( ... );
    message: |
      Unescaped echo statement detected - potential XSS vulnerability.

      Always escape output based on context:
      - HTML context: esc_html()
      - Attribute context: esc_attr()
      - URL context: esc_url()
      - Rich HTML: wp_kses_post()

      Example:
      ❌ echo $user_input;
      ✅ echo esc_html( $user_input );
    languages: [php]
    severity: WARNING
    metadata:
      category: security
      technology:
        - wordpress
      confidence: MEDIUM
      likelihood: HIGH
      impact: HIGH
      subcategory:
        - xss
      cwe:
        - "CWE-79: Cross-site Scripting"

  - id: detect-wrong-escaping-context
    pattern-regex: (esc_html\s*\(\s*\$[a-zA-Z_]*url[a-zA-Z_]*\s*\)|esc_url\s*\(\s*\$[a-zA-Z_]*text[a-zA-Z_]*\s*\))
    message: |
      Wrong escaping function for context detected.

      Context-specific escaping:
      - href/src attributes: Use esc_url()
      - class/id attributes: Use esc_attr()
      - HTML body text: Use esc_html()

      Example:
      ❌ <a href="<?php echo esc_html( $url ); ?>">
      ✅ <a href="<?php echo esc_url( $url ); ?>">
    languages: [php]
    severity: WARNING
    metadata:
      category: security
      technology:
        - wordpress

  - id: recommend-late-escaping
    pattern-regex: \$\w+\s*=\s*esc_(html|attr)\s*\([^\)]+\);\s*.*\s*update_(post_meta|option)\s*\(
    message: |
      Early escaping detected - may cause double-escaping.

      WordPress best practice: Escape at output, not at storage.

      Example:
      ❌ $name = esc_html( $_POST['name'] );
         update_user_meta( $user_id, 'name', $name );
         // Later: echo esc_html( get_user_meta(...) ); // Double escaped!

      ✅ $name = sanitize_text_field( $_POST['name'] );
         update_user_meta( $user_id, 'name', $name );
         // Later: echo esc_html( get_user_meta(...) ); // Correctly escaped
    languages: [php]
    severity: INFO
    metadata:
      category: best-practice
      technology:
        - wordpress

  - id: trust-database-data-antipattern
    pattern-regex: echo\s+(get_post_meta|get_option|get_user_meta)\s*\(
    message: |
      Database data output without escaping - trust no data!

      Even database-stored data should be escaped, as database could be
      compromised or contain legacy unescaped content.

      Example:
      ❌ echo get_post_meta( $post_id, 'title', true );
      ✅ echo esc_html( get_post_meta( $post_id, 'title', true ) );
    languages: [php]
    severity: WARNING
    metadata:
      category: security
      technology:
        - wordpress
