rules:
  - id: require-cpt-namespace-prefix
    languages:
      - php
    message: |
      Custom post type machine names must use namespace prefix to prevent collisions.

      Pattern: {client}_{type} using snake_case

      Examples:
        ✅ Good: 'kelsey_event', 'bnb_profile', 'acme_product'
        ❌ Bad: 'event', 'profile', 'product' (no prefix)

      Prevents conflicts with WordPress core types (post, page, attachment) and
      other plugins registering identically-named post types.
    severity: ERROR
    patterns:
      - pattern: register_post_type($CPT_NAME, ...)
      - metavariable-regex:
          metavariable: $CPT_NAME
          regex: '^["\'](?!.+_.+)[a-z]+["\']$'
    fix-regex:
      regex: 'register_post_type\s*\(\s*["\']([a-z]+)["\']\s*,'
      replacement: "register_post_type('prefix_\\1',"
    metadata:
      category: correctness
      technology:
        - wordpress
        - custom-post-types
      cwe: CWE-710
      confidence: HIGH
      likelihood: HIGH
      impact: HIGH
      subcategory:
        - vuln
      references:
        - https://developer.wordpress.org/plugins/post-types/registering-custom-post-types/#naming-best-practices
      source: custom-post-types-taxonomies-patterns

  - id: require-taxonomy-namespace-prefix
    languages:
      - php
    message: |
      Custom taxonomy machine names must use namespace prefix to prevent collisions.

      Pattern: {client}_{taxonomy} using snake_case

      Examples:
        ✅ Good: 'kelsey_event_category', 'bnb_country_content'
        ❌ Bad: 'event_category', 'categories' (no prefix or too generic)

      Prevents conflicts with WordPress core taxonomies (category, post_tag) and
      other plugins.
    severity: ERROR
    patterns:
      - pattern: register_taxonomy($TAX_NAME, ...)
      - metavariable-regex:
          metavariable: $TAX_NAME
          regex: '^["\'](?!.+_.+)[a-z]+["\']$'
    metadata:
      category: correctness
      technology:
        - wordpress
        - taxonomies
      cwe: CWE-710
      confidence: HIGH
      likelihood: HIGH
      impact: HIGH
      subcategory:
        - vuln
      references:
        - https://developer.wordpress.org/plugins/taxonomies/working-with-custom-taxonomies/#naming-conventions
      source: custom-post-types-taxonomies-patterns
