rules:
  - id: require-image-metadata
    patterns:
      - pattern-either:
          - pattern: |
              $IMAGE.asset->{
                url
              }
          - pattern: |
              $IMAGE.asset-> {
                url
              }
      - pattern-not: |
          $IMAGE.asset->{
            ...,
            metadata
          }
    message: |
      Image asset dereferencing should include metadata.dimensions for Next.js Image component.
      Fetching only the URL without dimensions causes layout shifts and requires client-side dimension fetching.

      Incomplete image expansion (missing metadata):
        'heroImage': heroImage.asset->{
          url
        }

      Complete image expansion with metadata (recommended):
        'heroImage': heroImage.asset->{
          url,
          'width': metadata.dimensions.width,
          'height': metadata.dimensions.height,
          'aspectRatio': metadata.dimensions.aspectRatio,
          'blurHash': metadata.blurHash
        }

      Using reusable partial (best practice):
        // partials/imgReference.ts
        const imgReference = `{
          url,
          'width': metadata.dimensions.width,
          'height': metadata.dimensions.height,
          'aspectRatio': metadata.dimensions.aspectRatio,
          'blurHash': metadata.blurHash
        }`

        // query.ts
        'heroImage': heroImage.asset->${imgReference}

      Required fields for Next.js Image component:
      - url: Image source URL
      - metadata.dimensions.width: Image width in pixels
      - metadata.dimensions.height: Image height in pixels

      Optional but recommended fields:
      - metadata.dimensions.aspectRatio: For responsive sizing
      - metadata.blurHash: For progressive loading / blur placeholder
      - altText: Accessibility (should be in image field, not asset)

      Observed in codebases:
      - 100% adoption of image metadata pattern
      - All 3 projects have dedicated image reference partials
      - 134 total reference expansions across 51 query files
      - 40% of expansions are image asset references

      Performance impact:
      - Fetching dimensions server-side prevents cumulative layout shift (CLS)
      - blurHash enables progressive image loading
      - aspectRatio maintains layout during image loading
    languages:
      - typescript
      - javascript
    severity: WARNING
    metadata:
      category: sanity
      confidence: HIGH
      likelihood: HIGH
      impact: HIGH
      subcategory:
        - best-practice
        - performance
        - ux
      references:
        - https://www.sanity.io/docs/image-type
        - https://nextjs.org/docs/api-reference/next/image
      source_confidence: 100%
